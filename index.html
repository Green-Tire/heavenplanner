<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hemelplanner</title>

    <style>
        :root { 
            --circle-bg: white; 
            --theme-color: black; 
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--theme-color) !important;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .universe-container {
            position: relative;
            width: 75vmin; height: 75vmin;
            display: flex; justify-content: center; align-items: center;
        }

        .circle {
            position: absolute;
            width: 100%; height: 100%;
            background-color: white !important;
            border-radius: 50%;
            z-index: 0;
            border: 1px solid transparent;
        }

        /* ZON */
        .celestial-body {
            position: absolute; 
            z-index: 5; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center;
        }
        .sun { top: -14vmin; width: 12vmin; height: 12vmin; }
        .sun svg { width: 100%; height: 100%; fill: white; }
        .sun svg line { stroke: white; }
        
        /* MAAN */
        .moon-container {
            position: absolute; bottom: -12vmin; 
            width: 8vmin; height: 8vmin;
            border-radius: 50%; border: 2px solid white !important;
            left: 50%; transform: translateX(-50%);
            z-index: 5; background-color: white !important;
            overflow: hidden;
        }

        .moon-container::after {
            content: '';
            position: absolute;
            top: 0; width: 50%; height: 100%;
            background-color: black !important;
            display: none;
            z-index: 6;
        }
        .moon-first-quarter::after { display: block; left: 0; }
        .moon-last-quarter::after { display: block; right: 0; }
        .moon-new { background-color: black !important; }

        /* UREN RING */
        #ticks-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        .hour-tick { position: absolute; top: 0; left: 50%; height: 100%; width: 2px; pointer-events: none; }
        .tick-mark { width: 2px; height: 4%; background-color: black !important; margin: 0 auto; }
        .tick-12 .tick-mark { width: 6px; height: 8%; }

        .hour-number {
            position: absolute; top: 10%; left: 50%;
            transform: translateX(-50%);
            font-weight: bold; font-size: 3.5vmin; color: black !important;
        }

        /* PIJLEN */
        .arrow-wrapper { position: absolute; top: 50%; left: 50%; width: 2px; height: 2px; z-index: 10; }
        .arrow-icon {
            color: white; font-size: 8vmin; font-weight: 900;
            position: absolute; transform: translateY(-46vmin); 
        }

        /* MENU */
        #draggable-menu {
            position: absolute; top: 20px; left: 20px;
            display: flex; gap: 10px; padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 40px; cursor: grab; z-index: 1000;
        }

        .menu-item {
            position: relative; width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.15); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.2rem;
        }

        .expandable { display: none; position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; }
        .expand-down { top: 100%; padding-top: 10px; }
        .expand-up { bottom: 100%; padding-bottom: 10px; }
        .menu-item.active .expandable { display: block; }

        .expandable-content {
            background: rgba(20, 20, 20, 0.95); padding: 10px; border-radius: 15px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sub-icon {
            width: 35px; height: 35px; background: rgba(255, 255, 255, 0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.1rem;
        }

        .dropped-icon {
            position: absolute; width: 8vmin; height: 8vmin; /* Iets kleiner gemaakt */
            background-color: var(--theme-color) !important; 
            color: white !important; border: 1px solid white; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: grab; z-index: 500; font-size: 4.5vmin; transform: translate(-50%, -50%);
        }

        #color-picker { position: absolute; opacity: 0; width: 0; height: 0; }

        /* --- FIX VOOR PRINTWEERGAVE --- */
        @media print {
            body, html { background: white !important; color: black !important; }
            #draggable-menu { display: none !important; }
            .universe-container { width: 16cm; height: 16cm; }
            .circle { border: 2px solid black !important; background: white !important; }
            
            /* Zon op zwart */
            .sun svg { fill: black !important; }
            .sun svg line { stroke: black !important; stroke-width: 2.5px; }
            
            /* Pijlen en tekst */
            .arrow-icon { color: black !important; }
            .hour-number { color: black !important; }
            .tick-mark { background-color: black !important; -webkit-print-color-adjust: exact; }

            /* Maan: geforceerd zwart via border of filter */
            .moon-container { border: 2px solid black !important; background-color: white !important; }
            .moon-container::after { 
                display: block;
                background-color: black !important; 
                -webkit-print-color-adjust: exact; 
                box-shadow: inset 0 0 0 1000px black; /* Extra force voor printers */
            }
            .moon-new { box-shadow: inset 0 0 0 1000px black !important; }

            /* Icoontjes: geforceerd zwart achtergrond */
            .dropped-icon { 
                background-color: black !important; 
                color: white !important; 
                border: 1px solid black !important;
                box-shadow: inset 0 0 0 1000px black !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div class="universe-container" id="universe">
        <div id="ticks-container"></div>
        <div id="arrows-container"></div>
        
        <div class="celestial-body sun">
            <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5" />
                <line x1="12" y1="1" x2="12" y2="3" stroke-width="2" stroke-linecap="round" />
                <line x1="12" y1="21" x2="12" y2="23" stroke-width="2" stroke-linecap="round" />
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke-width="2" stroke-linecap="round" />
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke-width="2" stroke-linecap="round" />
                <line x1="1" y1="12" x2="3" y2="12" stroke-width="2" stroke-linecap="round" />
                <line x1="21" y1="12" x2="23" y2="12" stroke-width="2" stroke-linecap="round" />
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke-width="2" stroke-linecap="round" />
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke-width="2" stroke-linecap="round" />
            </svg>
        </div> 

        <div class="circle"></div>
        <div id="moon-phase" class="moon-container"></div> 
    </div>

    <div id="draggable-menu">
        <div id="add-btn" class="menu-item"><span>Ôºã</span>
            <div id="expand-box" class="expandable expand-down">
                <div class="expandable-content" id="sub-menu">
                    <div class="sub-icon" onclick="spawnIcon('‚è∞')">‚è∞</div>
                    <div class="sub-icon" onclick="spawnIcon('üïå')">üïå</div>
                    <div class="sub-icon" onclick="spawnIcon('üìñ')">üìñ</div>
                    <div class="sub-icon" onclick="spawnIcon('üöø')">üöø</div>
                    <div class="sub-icon" onclick="spawnIcon('üçé')">üçé</div>
                    <div class="sub-icon" onclick="spawnIcon('‚òï')">‚òï</div>
                    <div class="sub-icon" onclick="spawnIcon('üìà')">üìà</div>
                    <div class="sub-icon" onclick="spawnIcon('ü•™')">ü•™</div>
                    <div class="sub-icon" onclick="spawnIcon('üé≠')">üé≠</div>
                    <div class="sub-icon" onclick="spawnIcon('üí™')">üí™</div>
                    <div class="sub-icon" onclick="spawnIcon('üç¥')">üç¥</div>
                    <div class="sub-icon" onclick="spawnIcon('üõå')">üõå</div>
                </div>
            </div>
        </div>
        <label for="color-picker" class="menu-item" style="cursor: pointer;">
            <span>üé®</span><input type="color" id="color-picker" value="#000000">
        </label>
        <div id="print-btn" class="menu-item" onclick="window.print()"><span>‚éô</span></div>
    </div>

    <script>
        let activeElement = null;
        let startX, startY, elemStartX, elemStartY;
        let isDragging = false;
        
        const menu = document.getElementById("draggable-menu");
        const addBtn = document.getElementById("add-btn");
        const universe = document.getElementById("universe");
        const colorPicker = document.getElementById("color-picker");

        colorPicker.addEventListener('input', (e) => {
            const newColor = e.target.value;
            document.documentElement.style.setProperty('--theme-color', newColor);
            saveState();
        });

        addBtn.addEventListener('click', (e) => {
            if (!isDragging) { addBtn.classList.toggle('active'); e.stopPropagation(); }
        });

        document.addEventListener('click', () => addBtn.classList.remove('active'));

        function startDragging(e) {
            const target = e.target.closest('#draggable-menu, .dropped-icon');
            if (!target || e.target.closest('.expandable-content') || e.target.closest('#color-picker')) return;
            isDragging = false; activeElement = target;
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            startX = touch.clientX; startY = touch.clientY;
            if (activeElement === menu) {
                elemStartX = activeElement.offsetLeft; elemStartY = activeElement.offsetTop;
            } else {
                const rect = activeElement.getBoundingClientRect();
                const cRect = universe.getBoundingClientRect();
                elemStartX = ((rect.left + rect.width/2 - cRect.left) / cRect.width) * 100;
                elemStartY = ((rect.top + rect.height/2 - cRect.top) / cRect.height) * 100;
            }
        }

        function moveDragging(e) {
            if (!activeElement) return;
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            const deltaX = touch.clientX - startX; const deltaY = touch.clientY - startY;
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) isDragging = true;
            if (activeElement === menu) {
                menu.style.left = (elemStartX + deltaX) + "px";
                menu.style.top = (elemStartY + deltaY) + "px";
                updateMenuOrientation(elemStartX + deltaX, elemStartY + deltaY);
            } else {
                const cRect = universe.getBoundingClientRect();
                activeElement.style.left = (elemStartX + (deltaX / cRect.width) * 100) + "%";
                activeElement.style.top = (elemStartY + (deltaY / cRect.height) * 100) + "%";
            }
        }

        function stopDragging() { if (activeElement && activeElement.classList.contains('dropped-icon')) saveState(); activeElement = null; }

        document.addEventListener("mousedown", startDragging);
        document.addEventListener("touchstart", startDragging, { passive: false });
        document.addEventListener("mousemove", moveDragging);
        document.addEventListener("touchmove", moveDragging, { passive: false });
        document.addEventListener("mouseup", stopDragging);
        document.addEventListener("touchend", stopDragging);

        function updateMenuOrientation(x, y) {
            menu.style.flexDirection = x < window.innerWidth / 2 ? "row-reverse" : "row";
            const expandBox = document.getElementById("expand-box");
            if (y > window.innerHeight / 2) expandBox.classList.replace("expand-down", "expand-up");
            else expandBox.classList.replace("expand-up", "expand-down");
        }

        function spawnIcon(emoji) {
            const div = document.createElement('div');
            div.className = 'dropped-icon'; div.innerText = emoji;
            div.style.left = "50%"; div.style.top = "50%";
            div.onclick = (e) => { if(!isDragging) { div.remove(); saveState(); } };
            universe.appendChild(div); saveState();
        }

        function drawClock(offset = 0) {
            const container = document.getElementById("ticks-container"); container.innerHTML = ''; 
            for (let i = 0; i < 24; i++) {
                const wrapper = document.createElement('div'); wrapper.className = 'hour-tick';
                if (i % 6 === 0) {
                    wrapper.classList.add('tick-12');
                    const num = document.createElement('div'); num.className = 'hour-number';
                    num.innerText = i === 0 ? "24" : (i < 10 ? "0"+i : i);
                    num.style.transform = `translateX(-50%) rotate(${-( (i-12)*15 + offset )}deg)`;
                    wrapper.appendChild(num);
                }
                const mark = document.createElement('div'); mark.className = 'tick-mark';
                wrapper.appendChild(mark);
                wrapper.style.transform = `translateX(-50%) rotate(${((i-12)*15)+offset}deg)`;
                container.appendChild(wrapper);
            }
        }

        function setMoonPhase() {
            const moonEl = document.getElementById("moon-phase");
            const cycle = 29.53; const now = new Date(); const reference = new Date('2024-01-11');
            const pos = ((now - reference) / (1000 * 60 * 60 * 24)) % cycle;
            moonEl.className = 'moon-container';
            if (pos < 2 || pos > 27.5) moonEl.classList.add('moon-new');
            else if (pos < 13) moonEl.classList.add('moon-first-quarter');
            else if (pos < 17) moonEl.classList.add('moon-full');
            else moonEl.classList.add('moon-last-quarter');
        }

        function getSolarData() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetch(`https://api.sunrise-sunset.org/json?lat=${pos.coords.latitude}&lng=${pos.coords.longitude}&formatted=0`)
                    .then(r => r.json()).then(data => {
                        const noon = new Date(data.results.solar_noon);
                        const offset = (12 - (noon.getHours() + noon.getMinutes() / 60)) * 15;
                        drawClock(offset);
                    });
                }, () => drawClock(0));
            } else drawClock(0);
        }

        function saveState() {
            const icons = [...document.querySelectorAll('.dropped-icon')].map(i => ({text: i.innerText, left: i.style.left, top: i.style.top}));
            localStorage.setItem('universeIcons', JSON.stringify(icons));
            localStorage.setItem('themeColor', getComputedStyle(document.documentElement).getPropertyValue('--theme-color'));
        }

        function loadState() {
            const savedIcons = JSON.parse(localStorage.getItem('universeIcons') || "[]");
            const savedColor = localStorage.getItem('themeColor');
            if (savedColor) { document.documentElement.style.setProperty('--theme-color', savedColor); colorPicker.value = savedColor.trim(); }
            savedIcons.forEach(d => {
                const div = document.createElement('div'); div.className = 'dropped-icon'; div.innerText = d.text;
                div.style.left = d.left; div.style.top = d.top;
                div.onclick = () => { if(!isDragging) { div.remove(); saveState(); } };
                universe.appendChild(div);
            });
        }
        getSolarData(); setMoonPhase(); loadState();
    </script>
</body>
</html>
