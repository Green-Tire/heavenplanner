<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hemelplanner Pro</title>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { 
            --theme-color: #000000; 
            --icon-bg: #000000;
            --day-color: rgb(204, 186, 108);
            --night-color: rgb(103, 126, 161);
            --line-thickness: 2px;
            --text-contrast: white;
            --celestial-contrast: white; 
            
            --menu-bg: rgba(255, 255, 255, 0.2);
            --menu-border: rgba(255, 255, 255, 0.3);
            --menu-item-bg: rgba(255, 255, 255, 0.15);
            --menu-text: white;
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--theme-color);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .universe-container {
            position: relative;
            width: 68vmin; height: 68vmin;
            display: flex; justify-content: center; align-items: center;
        }

        #dual-circle {
            position: absolute; width: 100%; height: 100%;
            transform: rotate(-90deg);
            z-index: 0;
            border-radius: 50%;
            box-sizing: border-box;
            border: 1px solid var(--celestial-contrast);
            transition: border-color 0.3s;
        }

        .celestial-body {
            position: absolute; z-index: 5; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center;
        }
        .sun { top: -13vmin; width: 11vmin; height: 11vmin; }
        .sun svg { width: 100%; height: 100%; fill: var(--celestial-contrast); transition: fill 0.3s; }
        .sun svg line { stroke: var(--celestial-contrast); transition: stroke 0.3s; }
        
        .moon-container {
            position: absolute; bottom: -11vmin; width: 7.5vmin; height: 7.5vmin;
            border-radius: 50%; 
            border: 2px solid var(--celestial-contrast) !important;
            left: 50%; transform: translateX(-50%);
            z-index: 5; background-color: white !important; overflow: hidden;
            transition: border-color 0.3s;
        }

        .moon-container::after {
            content: ''; position: absolute; top: 0; width: 50%; height: 100%;
            background-color: black !important; display: none; z-index: 6;
        }
        .moon-first-quarter::after { display: block; left: 0; }
        .moon-last-quarter::after { display: block; right: 0; }
        .moon-new { background-color: black !important; }

        #ticks-container, #solar-lines-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        .hour-tick { position: absolute; top: 0; left: 50%; height: 100%; width: 2px; pointer-events: none; }
        .tick-mark { width: 2px; height: 4%; background-color: black; margin: 0 auto; }
        .tick-12 .tick-mark { width: 6px; height: 8%; }
        .hour-number { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); font-weight: bold; font-size: 3.2vmin; }

        .solar-line {
            position: absolute; top: 0; left: 50%; width: var(--line-thickness); height: 50%;
            background-color: rgba(128,128,128,0.5); transform-origin: bottom center; z-index: 2;
        }

        #draggable-menu {
            position: absolute; top: 20px; left: 20px;
            display: flex; 
            flex-direction: row-reverse; 
            gap: 10px; padding: 8px 12px;
            background: var(--menu-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--menu-border); border-radius: 40px; cursor: grab; 
            z-index: 1000;
            transition: background 0.3s, border 0.3s;
        }

        .menu-item {
            position: relative; width: 40px; height: 40px;
            background: var(--menu-item-bg); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; 
            color: var(--menu-text); cursor: pointer;
        }

        .lucide { width: 20px; height: 20px; stroke: currentColor; stroke-width: 1.8px; }

        .expandable { display: none; position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; }
        .expand-down { top: 100%; padding-top: 10px; }
        .expand-up { bottom: 100%; padding-bottom: 10px; }
        .menu-item.active .expandable { display: block; }

        .expandable-content {
            background: rgba(20, 20, 20, 0.95); padding: 10px; border-radius: 15px;
            display: grid; gap: 8px; border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #palette-box .expandable-content { grid-template-columns: repeat(2, 1fr); }
        #expand-box .expandable-content { grid-template-columns: repeat(3, 1fr); }

        .sub-icon {
            width: 35px; height: 35px; background: rgba(255, 255, 255, 0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: white; cursor: pointer; overflow: hidden; position: relative;
        }

        .dropped-icon {
            position: absolute; width: 7vmin; height: 7vmin;
            background-color: var(--icon-bg); color: var(--text-contrast); 
            border: 1px solid transparent; /* Dunnere rand: 1px */
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: grab; z-index: 500; font-size: 3.5vmin; transform: translate(-50%, -50%);
            box-sizing: border-box;
        }

        .spawning { z-index: 2000 !important; }

        .color-input { 
            position: absolute; opacity: 0; width: 100%; height: 100%; 
            cursor: pointer; pointer-events: auto; 
        }

        @media print {
            body, html { background-color: var(--theme-color) !important; }
            #draggable-menu { display: none; }
        }
    </style>
</head>
<body>

    <div class="universe-container" id="universe">
        <svg id="dual-circle" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="50" id="night-path" fill="var(--night-color)" />
            <path id="day-path" fill="var(--day-color)" />
        </svg>

        <div id="solar-lines-container"></div>
        <div id="ticks-container"></div>
        
        <div class="celestial-body sun">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" stroke-width="2" /><line x1="12" y1="21" x2="12" y2="23" stroke-width="2" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke-width="2" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke-width="2" /><line x1="1" y1="12" x2="3" y2="12" stroke-width="2" /><line x1="21" y1="12" x2="23" y2="12" stroke-width="2" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke-width="2" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke-width="2" /></svg>
        </div> 

        <div id="moon-phase" class="moon-container"></div> 
    </div>

    <div id="draggable-menu">
        <div id="print-btn" class="menu-item" onclick="window.print()"><i data-lucide="printer"></i></div>
        <div id="palette-btn" class="menu-item">
            <i data-lucide="palette"></i>
            <div id="palette-box" class="expandable expand-down">
                <div class="expandable-content">
                    <label class="sub-icon"><i data-lucide="brush"></i><input type="color" class="color-input" id="bg-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="zap"></i><input type="color" class="color-input" id="icon-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="sun"></i><input type="color" class="color-input" id="day-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="moon"></i><input type="color" class="color-input" id="night-color-pick"></label>
                </div>
            </div>
        </div>
        <div id="add-btn" class="menu-item">
            <i data-lucide="plus"></i>
            <div id="expand-box" class="expandable expand-down">
                <div class="expandable-content" id="sub-menu">
                    <div class="sub-icon" onmousedown="initDragSpawn(event, '‚è∞')" ontouchstart="initDragSpawn(event, '‚è∞')">‚è∞</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üìª')" ontouchstart="initDragSpawn(event, 'üìª')">üìª</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üïå')" ontouchstart="initDragSpawn(event, 'üïå')">üïå</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üìñ')" ontouchstart="initDragSpawn(event, 'üìñ')">üìñ</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üí™')" ontouchstart="initDragSpawn(event, 'üí™')">üí™</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üçé')" ontouchstart="initDragSpawn(event, 'üçé')">üçé</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, '‚òï')" ontouchstart="initDragSpawn(event, '‚òï')">‚òï</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üçΩÔ∏è')" ontouchstart="initDragSpawn(event, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üõå')" ontouchstart="initDragSpawn(event, 'üõå')">üõå</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let currentSunriseAngle = 90, currentSunsetAngle = 270;

        function getContrastYIQ(hexcolor){
            if (!hexcolor) return 'black';
            if (hexcolor.startsWith('rgb')) {
                const colors = hexcolor.match(/\d+/g);
                var r = parseInt(colors[0]), g = parseInt(colors[1]), b = parseInt(colors[2]);
            } else {
                hexcolor = hexcolor.replace("#", "");
                var r = parseInt(hexcolor.substr(0,2),16), g = parseInt(hexcolor.substr(2,2),16), b = parseInt(hexcolor.substr(4,2),16);
            }
            return (((r*299)+(g*587)+(b*114))/1000 >= 128) ? 'black' : 'white';
        }

        function updateIconBorder(icon) {
            const rect = icon.getBoundingClientRect();
            const containerRect = universe.getBoundingClientRect();
            
            const centerX = containerRect.left + containerRect.width / 2;
            const centerY = containerRect.top + containerRect.height / 2;
            const x = (rect.left + rect.width / 2) - centerX;
            const y = (rect.top + rect.height / 2) - centerY;

            let angle = Math.atan2(y, x) * (180 / Math.PI);
            angle = (angle + 360 + 90) % 360;

            const dayColor = getComputedStyle(document.documentElement).getPropertyValue('--day-color').trim();
            const nightColor = getComputedStyle(document.documentElement).getPropertyValue('--night-color').trim();
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim();

            const dist = Math.sqrt(x*x + y*y);
            const radius = containerRect.width / 2;

            if (dist < radius) {
                const isDay = isAngleBetween(angle, currentSunriseAngle, currentSunsetAngle);
                icon.style.borderColor = isDay ? getContrastYIQ(dayColor) : getContrastYIQ(nightColor);
            } else {
                icon.style.borderColor = getContrastYIQ(themeColor);
            }
        }

        function updateColors() {
            const root = document.documentElement;
            const bg = getComputedStyle(root).getPropertyValue('--theme-color').trim();
            const day = getComputedStyle(root).getPropertyValue('--day-color').trim();
            const night = getComputedStyle(root).getPropertyValue('--night-color').trim();
            const iconBg = getComputedStyle(root).getPropertyValue('--icon-bg').trim();

            const bgContrast = getContrastYIQ(bg);
            root.style.setProperty('--celestial-contrast', bgContrast);
            root.style.setProperty('--text-contrast', getContrastYIQ(iconBg));

            if (bgContrast === 'black') { 
                root.style.setProperty('--menu-bg', 'rgba(0, 0, 0, 0.8)');
                root.style.setProperty('--menu-border', 'rgba(0, 0, 0, 0.4)');
            } else {
                root.style.setProperty('--menu-bg', 'rgba(255, 255, 255, 0.2)');
                root.style.setProperty('--menu-border', 'rgba(255, 255, 255, 0.3)');
            }
            
            document.querySelectorAll('.hour-tick').forEach(tick => {
                const angle = parseFloat(tick.getAttribute('data-angle'));
                const normalizedAngle = (angle % 360 + 360) % 360;
                const isDay = isAngleBetween(normalizedAngle, currentSunriseAngle, currentSunsetAngle);
                const color = isDay ? getContrastYIQ(day) : getContrastYIQ(night);
                tick.querySelector('.tick-mark').style.backgroundColor = color;
                const num = tick.querySelector('.hour-number');
                if(num) num.style.color = color;
            });

            document.querySelectorAll('.dropped-icon').forEach(updateIconBorder);
        }

        function isAngleBetween(target, start, end) {
            const s = (start % 360 + 360) % 360, e = (end % 360 + 360) % 360, t = (target % 360 + 360) % 360;
            return s <= e ? (t >= s && t <= e) : (t >= s || t <= e);
        }

        const colorPicks = {'bg-color-pick': '--theme-color', 'icon-color-pick': '--icon-bg', 'day-color-pick': '--day-color', 'night-color-pick': '--night-color'};
        Object.entries(colorPicks).forEach(([id, prop]) => {
            const el = document.getElementById(id);
            // Fix voor mobiel: Stop propagatie zodat drag-script niet afgaat
            el.addEventListener('touchstart', (e) => e.stopPropagation(), {passive: true});
            el.addEventListener('mousedown', (e) => e.stopPropagation());
            
            el.addEventListener('input', (e) => {
                document.documentElement.style.setProperty(prop, e.target.value);
                updateColors(); saveState();
            });
        });

        let activeElement = null, startX, startY, elemStartX, elemStartY, isDragging = false;
        const menu = document.getElementById("draggable-menu");
        const universe = document.getElementById("universe");

        document.getElementById("add-btn").addEventListener('click', (e) => { e.stopPropagation(); document.getElementById("add-btn").classList.toggle('active'); document.getElementById("palette-btn").classList.remove('active'); });
        document.getElementById("palette-btn").addEventListener('click', (e) => { e.stopPropagation(); document.getElementById("palette-btn").classList.toggle('active'); document.getElementById("add-btn").classList.remove('active'); });
        document.addEventListener('click', () => { document.getElementById("add-btn").classList.remove('active'); document.getElementById("palette-btn").classList.remove('active'); });

        function startDragging(e) {
            const target = e.target.closest('#draggable-menu, .dropped-icon');
            // Als we in het menu zitten maar op een input klikken, niet gaan slepen
            if (!target || e.target.closest('.expandable-content')) return;
            isDragging = false; activeElement = target;
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            startX = touch.clientX; startY = touch.clientY;
            if (activeElement === menu) { elemStartX = activeElement.offsetLeft; elemStartY = activeElement.offsetTop; }
            else { const r = activeElement.getBoundingClientRect(), cr = universe.getBoundingClientRect(); elemStartX = ((r.left + r.width/2 - cr.left) / cr.width) * 100; elemStartY = ((r.top + r.height/2 - cr.top) / cr.height) * 100; }
        }

        function initDragSpawn(e, emoji) {
            e.preventDefault(); e.stopPropagation();
            const div = document.createElement('div'); div.className = 'dropped-icon spawning'; div.innerText = emoji;
            const cr = universe.getBoundingClientRect();
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            const spawnX = ((touch.clientX - cr.left) / cr.width) * 100;
            const spawnY = ((touch.clientY - cr.top) / cr.height) * 100;
            div.style.left = spawnX + "%"; div.style.top = spawnY + "%";
            div.onclick = (ev) => { if(!isDragging) { div.remove(); saveState(); } ev.stopPropagation(); };
            universe.appendChild(div);
            updateIconBorder(div);
            activeElement = div; isDragging = true;
            startX = touch.clientX; startY = touch.clientY; elemStartX = spawnX; elemStartY = spawnY;
        }

        function moveDragging(e) {
            if (!activeElement) return;
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            const dx = touch.clientX - startX, dy = touch.clientY - startY;
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) isDragging = true;
            if (activeElement === menu) {
                menu.style.left = (elemStartX + dx) + "px"; menu.style.top = (elemStartY + dy) + "px";
                updateMenuOrientation(elemStartX + dx, elemStartY + dy);
            } else {
                const cr = universe.getBoundingClientRect();
                activeElement.style.left = (elemStartX + (dx / cr.width) * 100) + "%";
                activeElement.style.top = (elemStartY + (dy / cr.height) * 100) + "%";
                updateIconBorder(activeElement);
            }
        }

        function updateMenuOrientation(x, y) {
            menu.style.flexDirection = x < window.innerWidth / 2 ? "row-reverse" : "row";
            [document.getElementById("expand-box"), document.getElementById("palette-box")].forEach(box => {
                if (y > window.innerHeight / 2) box.classList.replace("expand-down", "expand-up");
                else box.classList.replace("expand-up", "expand-down");
            });
        }

        document.addEventListener("mousedown", startDragging);
        document.addEventListener("touchstart", startDragging, { passive: false });
        document.addEventListener("mousemove", moveDragging);
        document.addEventListener("touchmove", moveDragging, { passive: false });
        document.addEventListener("mouseup", endDragging);
        document.addEventListener("touchend", endDragging);

        function endDragging() {
            if (activeElement) { activeElement.classList.remove('spawning'); saveState(); }
            activeElement = null;
        }

        function drawClock(offset = 0) {
            const container = document.getElementById("ticks-container"); container.innerHTML = ''; 
            for (let i = 0; i < 24; i++) {
                const angle = ((i-12)*15)+offset;
                const wrapper = document.createElement('div'); wrapper.className = 'hour-tick';
                wrapper.setAttribute('data-angle', angle);
                if (i % 6 === 0) {
                    wrapper.classList.add('tick-12');
                    const num = document.createElement('div'); num.className = 'hour-number';
                    num.innerText = i === 0 ? "24" : (i < 10 ? "0"+i : i);
                    num.style.transform = `translateX(-50%) rotate(${-angle}deg)`;
                    wrapper.appendChild(num);
                }
                const mark = document.createElement('div'); mark.className = 'tick-mark';
                wrapper.appendChild(mark); wrapper.style.transform = `translateX(-50%) rotate(${angle}deg)`;
                container.appendChild(wrapper);
            }
            updateColors();
        }

        function getSolarData() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetch(`https://api.sunrise-sunset.org/json?lat=${pos.coords.latitude}&lng=${pos.coords.longitude}&formatted=0`)
                    .then(r => r.json()).then(data => {
                        const noon = new Date(data.results.solar_noon);
                        const offset = (12 - (noon.getHours() + noon.getMinutes() / 60)) * 15;
                        const sunRise = new Date(data.results.sunrise), sunSet = new Date(data.results.sunset);
                        currentSunriseAngle = (sunRise.getHours() + sunRise.getMinutes()/60 - 12) * 15 + offset;
                        currentSunsetAngle = (sunSet.getHours() + sunSet.getMinutes()/60 - 12) * 15 + offset;
                        drawClock(offset);
                        const polarToCartesian = (angleDeg) => {
                            const angleRad = (angleDeg * Math.PI) / 180.0;
                            return { x: 50 + 50 * Math.cos(angleRad), y: 50 + 50 * Math.sin(angleRad) };
                        };
                        const start = polarToCartesian(currentSunriseAngle), end = polarToCartesian(currentSunsetAngle);
                        const largeArcFlag = (currentSunsetAngle - currentSunriseAngle + 360) % 360 <= 180 ? "0" : "1";
                        document.getElementById("day-path").setAttribute("d", ["M", 50, 50, "L", start.x, start.y, "A", 50, 50, 0, largeArcFlag, 1, end.x, end.y, "Z"].join(" "));
                        const slc = document.getElementById("solar-lines-container"); slc.innerHTML = '';
                        [currentSunriseAngle, currentSunsetAngle].forEach(ang => {
                            const line = document.createElement('div'); line.className = 'solar-line';
                            line.style.transform = `translateX(-50%) rotate(${ang}deg)`;
                            slc.appendChild(line);
                        });
                        updateColors();
                    });
                }, () => drawClock(0));
            } else drawClock(0);
        }

        function saveState() {
            const icons = [...document.querySelectorAll('.dropped-icon')].map(i => ({text: i.innerText, left: i.style.left, top: i.style.top}));
            localStorage.setItem('universeIcons', JSON.stringify(icons));
            localStorage.setItem('themeColor', getComputedStyle(document.documentElement).getPropertyValue('--theme-color'));
            localStorage.setItem('iconBg', getComputedStyle(document.documentElement).getPropertyValue('--icon-bg'));
        }

        function loadState() {
            const tc = localStorage.getItem('themeColor'); if (tc) document.documentElement.style.setProperty('--theme-color', tc);
            const ib = localStorage.getItem('iconBg'); if (ib) document.documentElement.style.setProperty('--icon-bg', ib);
            const savedIcons = JSON.parse(localStorage.getItem('universeIcons') || "[]");
            savedIcons.forEach(d => {
                const div = document.createElement('div'); div.className = 'dropped-icon'; div.innerText = d.text;
                div.style.left = d.left; div.style.top = d.top;
                div.onclick = (e) => { if(!isDragging) { div.remove(); saveState(); } e.stopPropagation(); };
                universe.appendChild(div);
            });
            getSolarData();
        }
        
        loadState();
        
        (function setMoonPhase() {
            const moonEl = document.getElementById("moon-phase");
            const cycle = 29.53, now = new Date(), ref = new Date('2024-01-11');
            const pos = ((now - ref) / (1000 * 60 * 60 * 24)) % cycle;
            if (pos < 2 || pos > 27.5) moonEl.classList.add('moon-new');
            else if (pos < 13) moonEl.classList.add('moon-first-quarter');
            else if (pos < 17) moonEl.classList.add('moon-full');
            else moonEl.classList.add('moon-last-quarter');
        })();
    </script>
</body>
</html>
