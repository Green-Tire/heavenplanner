<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hemelplanner</title>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { 
            --theme-color: #000000;
            --icon-bg: #000000;
            --day-color: rgb(204, 186, 108);
            --night-color: rgb(103, 126, 161);
            --line-thickness: 2px;
            --text-contrast: white;
            --celestial-contrast: white;
            --menu-bg: rgba(255, 255, 255, 0.2);
            --menu-border: rgba(255, 255, 255, 0.3);
            --menu-item-bg: rgba(255, 255, 255, 0.15);
            --menu-text: white;
            --zoom-level: 1;
            --pan-x: 0;
            --pan-y: 0;
        }
        
        body, html {
            margin: 0;
            padding: 0; width: 100%; height: 100%;
            background-color: var(--theme-color);
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #welcome-popup, #location-popup {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
            z-index: 9999; backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #welcome-popup { display: flex; }
        #location-popup { display: none; }

        .popup-content {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); padding: 30px; border-radius: 25px;
            max-width: 85%; width: 400px;
            color: white; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .popup-close { 
            position: absolute;
            top: 15px; right: 15px; 
            cursor: pointer; 
            color: white; 
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            width: 30px; height: 30px;
        }
        
        .popup-content h2 { margin-top: 0; font-size: 1.4rem; }
        .popup-content ol { padding-left: 20px; line-height: 1.6; }

        .zoom-wrapper {
            position: relative;
            display: flex; justify-content: center; align-items: center;
            transform: translate(calc(var(--pan-x) * 1px), calc(var(--pan-y) * 1px)) scale(var(--zoom-level));
            transition: transform 0.2s ease-out; width: 100%; height: 100%; z-index: 10;
        }

        .universe-container {
            position: relative;
            width: 85vmin; height: 85vmin;
            display: flex; justify-content: center; align-items: center; flex-shrink: 0; z-index: 1;
        }

        #stickers-layer { 
            position: absolute; top: 50%; left: 50%; width: 85vmin; height: 85vmin;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 30; 
        }

        #dual-circle {
            position: absolute;
            width: 100%; height: 100%;
            z-index: 0;
            border-radius: 50%; box-sizing: border-box; border: 1px solid var(--celestial-contrast);
            overflow: visible;
        }

        .sun { position: absolute; z-index: 5; left: 50%; transform: translateX(-50%); top: -18%; width: 15%; height: 15%; }
        .sun svg { width: 100%; height: 100%; fill: var(--celestial-contrast); }
        .sun svg line { stroke: var(--celestial-contrast); }
        
        .moon-container {
            position: absolute;
            bottom: -16%; width: 11%; height: 11%;
            border-radius: 50%; border: 2px solid var(--celestial-contrast) !important;
            left: 50%; transform: translateX(-50%); z-index: 5;
            background-color: white !important; overflow: hidden;
        }
        .moon-container::after { content: ''; position: absolute; top: 0; width: 50%; height: 100%; background-color: black !important; display: none; z-index: 6; }
        .moon-first-quarter::after { display: block; left: 0; }
        .moon-last-quarter::after { display: block; right: 0; }
        .moon-new { background-color: black !important; }

        #ticks-container { position: absolute; width: 100%; height: 100%; z-index: 1; }
        .hour-tick { position: absolute; top: 0; left: 50%; height: 100%; width: 2px; pointer-events: none; }
        .tick-mark { width: 2px; height: 4%; background-color: black; margin: 0 auto; }
        .hour-number { position: absolute; top: 6%; left: 50%; transform: translateX(-50%); font-weight: bold; font-size: 3.5vmin; }

        #draggable-menu {
            position: absolute;
            top: 20px; left: 20px; display: flex; flex-direction: row; gap: 10px; padding: 8px 12px;
            background: var(--menu-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--menu-border); border-radius: 40px; cursor: grab; z-index: 5000;
        }

        #draggable-menu.mirrored { flex-direction: row-reverse; }
        .menu-item { position: relative; width: 40px; height: 40px; background: var(--menu-item-bg); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--menu-text); cursor: pointer; }
        .expandable { display: none; position: absolute; left: 50%; transform: translateX(-50%); z-index: 5100; }
        .expand-down { top: 100%; padding-top: 10px; }
        .expand-up { bottom: 100%; padding-bottom: 10px; }
        .menu-item.active .expandable { display: block; }
        .expandable-content { background: rgba(20, 20, 20, 0.95); padding: 12px; border-radius: 15px; display: grid; gap: 8px; border: 1px solid rgba(255, 255, 255, 0.2); min-width: 40px; }
        #palette-box .expandable-content { grid-template-columns: repeat(2, 1fr); }
        #expand-box .expandable-content { grid-template-columns: repeat(3, 1fr); }
        #download-box .expandable-content { grid-template-columns: repeat(2, 1fr); }
        
        .sub-icon { width: 35px; height: 35px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; cursor: pointer; overflow: hidden; position: relative; }

        .dropped-icon { 
            position: absolute;
            width: 9%; height: 9%;
            background-color: var(--icon-bg); color: var(--text-contrast);
            border: 1px solid transparent; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: grab; pointer-events: auto;
            font-size: 4vmin; transform: translate(-50%, -50%); z-index: 100; 
            box-sizing: border-box;
        }

        .sticker-group {
            display: inline-flex; flex-wrap: wrap; align-content: center; justify-content: center;
            padding: 1vmin !important; gap: 2px; width: 17% !important; height: 17% !important;
            aspect-ratio: 1 / 1; min-width: unset !important; min-height: unset !important; max-width: unset !important;
        }

        .group-emoji { font-size: 4vmin; line-height: 1; flex-shrink: 0; cursor: pointer; }
        .dragging { z-index: 6000 !important; }
        .color-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
            body, html { background-color: var(--theme-color) !important; }
            #draggable-menu, #welcome-popup, #location-popup { display: none !important; }
            .sun svg { fill: var(--celestial-contrast) !important; }
            .sun svg line { stroke: var(--celestial-contrast) !important; }
            .moon-container { border-color: var(--celestial-contrast) !important; background-color: white !important; }
            .moon-new { background-color: black !important; }
            .moon-first-quarter::after, .moon-last-quarter::after { background-color: black !important; }
            .dropped-icon { background-color: var(--icon-bg) !important; color: var(--text-contrast) !important; border-color: inherit !important; }
        }
    </style>
</head>
<body>

    <div id="welcome-popup">
        <div class="popup-content">
            <div class="popup-close" onclick="closePopup()"><i data-lucide="x"></i></div>
            <h2>Verborgen functies:</h2>
            <ol>
                <li>Sleep stickers naar je planner door te klikken op <b>+</b>.</li>
                <li>Verwijder stickers door erop te klikken.</li>
                <li>Groepeer stickers door ze op elkaar te slepen.</li>
                <li>Beweeg je planner door langer te drukken.</li>
                <li>Dag, nacht en de maanstand worden live berekend.</li>
            </ol>
        </div>
    </div>

    <div id="location-popup">
        <div class="popup-content">
            <div class="popup-close" onclick="document.getElementById('location-popup').style.display = 'none'"><i data-lucide="x"></i></div>
            <p style="text-align: center; margin-top: 10px; font-size: 1.1rem;">
                Je locatie kan helaas niet worden opgehaald. Probeer een priv√©tablad.
            </p>
        </div>
    </div>

    <div class="zoom-wrapper" id="zoom-wrapper">
        <div class="universe-container" id="universe">
            <svg id="dual-circle" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="50" id="night-path" fill="var(--night-color)" />
                <path id="day-path" fill="var(--day-color)" />
            </svg>
            <div id="solar-lines-container"></div>
            <div id="ticks-container"></div>
            <div class="sun">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" stroke-width="2" /><line x1="12" y1="21" x2="12" y2="23" stroke-width="2" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke-width="2" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke-width="2" /><line x1="1" y1="12" x2="3" y2="12" stroke-width="2" /><line x1="21" y1="12" x2="23" y2="12" stroke-width="2" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke-width="2" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke-width="2" /></svg>
            </div> 
            <div id="moon-phase" class="moon-container"></div> 
        </div>
        <div id="stickers-layer"></div>
    </div>

    <div id="draggable-menu">
        <div id="add-btn" class="menu-item"><i data-lucide="plus"></i>
            <div id="expand-box" class="expandable expand-down">
                <div class="expandable-content">
                    <div class="sub-icon" onmousedown="initDragSpawn(event, '‚è∞')" ontouchstart="initDragSpawn(event, '‚è∞')">‚è∞</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üìª')" ontouchstart="initDragSpawn(event, 'üìª')">üìª</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üöø')" ontouchstart="initDragSpawn(event, 'üöø')">üöø</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üïå')" ontouchstart="initDragSpawn(event, 'üïå')">üïå</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üìñ')" ontouchstart="initDragSpawn(event, 'üìñ')">üìñ</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üí™')" ontouchstart="initDragSpawn(event, 'üí™')">üí™</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üçé')" ontouchstart="initDragSpawn(event, 'üçé')">üçé</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, '‚òï')" ontouchstart="initDragSpawn(event, '‚òï')">‚òï</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üöå')" ontouchstart="initDragSpawn(event, 'üöå')">üöå</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üå≥')" ontouchstart="initDragSpawn(event, 'üå≥')">üå≥</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üìà')" ontouchstart="initDragSpawn(event, 'üìà')">üìà</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'ü•™')" ontouchstart="initDragSpawn(event, 'ü•™')">ü•™</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üçΩÔ∏è')" ontouchstart="initDragSpawn(event, 'üçΩÔ∏è')">üçΩÔ∏è</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶')" ontouchstart="initDragSpawn(event, 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, '‚úÇÔ∏è')" ontouchstart="initDragSpawn(event, '‚úÇÔ∏è')">‚úÇÔ∏è</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üß∏')" ontouchstart="initDragSpawn(event, 'üß∏')">üß∏</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üì∫')" ontouchstart="initDragSpawn(event, 'üì∫')">üì∫</div>
                    <div class="sub-icon" onmousedown="initDragSpawn(event, 'üõå')" ontouchstart="initDragSpawn(event, 'üõå')">üõå</div>
                </div>
            </div>
        </div>
        <div id="palette-btn" class="menu-item"><i data-lucide="palette"></i>
            <div id="palette-box" class="expandable expand-down">
                <div class="expandable-content">
                    <label class="sub-icon"><i data-lucide="brush"></i><input type="color" class="color-input" id="bg-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="zap"></i><input type="color" class="color-input" id="icon-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="sun"></i><input type="color" class="color-input" id="day-color-pick"></label>
                    <label class="sub-icon"><i data-lucide="moon"></i><input type="color" class="color-input" id="night-color-pick"></label>
                    <div class="sub-icon" onclick="resetColors()"><i data-lucide="redo-2"></i></div>
                </div>
            </div>
        </div>
        <div id="zoom-btn" class="menu-item"><i data-lucide="search"></i>
            <div id="zoom-box" class="expandable expand-down">
                <div class="expandable-content">
                    <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1">
                </div>
            </div>
        </div>
        <div id="download-btn" class="menu-item"><i data-lucide="download"></i>
            <div id="download-box" class="expandable expand-down">
                <div class="expandable-content">
                    <div class="sub-icon" onclick="exportPDF()"><i data-lucide="file-text"></i></div>
                    <div class="sub-icon" onclick="exportPNG()"><i data-lucide="image"></i></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function setFavicon() {
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
            const blob = new Blob([sunIcon], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('link'); link.rel = 'icon'; link.href = url; document.head.appendChild(link);
        }
        setFavicon(); lucide.createIcons();

        let hasLocationError = false;
        function showLocationError() { if (document.getElementById('welcome-popup').style.display === 'none') { document.getElementById('location-popup').style.display = 'flex'; } }
        function closePopup() { document.getElementById('welcome-popup').style.display = 'none'; if (hasLocationError) showLocationError(); }

        let currentSunriseAngle = 90, currentSunsetAngle = 270, activeElement = null, startX, startY, elemStartX, elemStartY, isDragging = false, isSpawning = false;
        let isPanning = false, panTimer = null, currentPanX = 0, currentPanY = 0, startPanX = 0, startPanY = 0;
        const menu = document.getElementById("draggable-menu");
        const universe = document.getElementById("universe");
        const zoomWrapper = document.getElementById("zoom-wrapper");
        const stickersLayer = document.getElementById("stickers-layer");

        function updateMenuDynamics() {
            const menuRect = menu.getBoundingClientRect();
            const expandables = document.querySelectorAll('.expandable');
            if (menuRect.top > window.innerHeight / 2) { expandables.forEach(el => { el.classList.remove('expand-down'); el.classList.add('expand-up'); }); }
            else { expandables.forEach(el => { el.classList.remove('expand-up'); el.classList.add('expand-down'); }); }
            if (menuRect.left + (menuRect.width / 2) > window.innerWidth / 2) menu.classList.add('mirrored');
            else menu.classList.remove('mirrored');
        }

        const colorPicks = {'bg-color-pick': '--theme-color', 'icon-color-pick': '--icon-bg', 'day-color-pick': '--day-color', 'night-color-pick': '--night-color'};
        Object.entries(colorPicks).forEach(([id, prop]) => {
            document.getElementById(id).addEventListener('input', (e) => { document.documentElement.style.setProperty(prop, e.target.value); updateColors(); saveState(); });
        });
        function resetColors() {
            const defaults = {'--theme-color': '#000000', '--icon-bg': '#000000', '--day-color': 'rgb(204, 186, 108)', '--night-color': 'rgb(103, 126, 161)'};
            Object.entries(defaults).forEach(([prop, val]) => document.documentElement.style.setProperty(prop, val)); updateColors(); saveState();
        }

        const btns = ["add-btn", "palette-btn", "zoom-btn", "download-btn"];
        btns.forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                if (isDragging || isPanning) return;
                if (id === "zoom-btn" && !e.target.closest('.expandable-content')) {
                    document.documentElement.style.setProperty('--zoom-level', 1);
                    zoomSlider.value = 1; currentPanX = 0; currentPanY = 0;
                    document.documentElement.style.setProperty('--pan-x', 0); document.documentElement.style.setProperty('--pan-y', 0); saveState();
                }
                if (!e.target.closest('.expandable-content')) { 
                    updateMenuDynamics(); 
                    btns.forEach(b => { if(b !== id) document.getElementById(b).classList.remove('active'); });
                    document.getElementById(id).classList.toggle('active');
                }
            });
        });

        document.addEventListener('click', (e) => { if (!e.target.closest('#draggable-menu')) btns.forEach(b => document.getElementById(b).classList.remove('active')); });
        const zoomSlider = document.getElementById("zoom-slider");
        zoomSlider.addEventListener('input', (e) => { document.documentElement.style.setProperty('--zoom-level', e.target.value); saveState(); });

        function getOverlap(el1, el2) {
            const r1 = el1.getBoundingClientRect(), r2 = el2.getBoundingClientRect();
            const x_overlap = Math.max(0, Math.min(r1.right, r2.right) - Math.max(r1.left, r2.left));
            const y_overlap = Math.max(0, Math.min(r1.bottom, r2.bottom) - Math.max(r1.top, r2.top));
            return (x_overlap * y_overlap) / (r1.width * r1.height);
        }

        function startDragging(e) {
            const target = e.target.closest('#draggable-menu, .dropped-icon');
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            startX = touch.clientX; startY = touch.clientY;
            
            if (!target || e.target.closest('.expandable-content') || e.target.classList.contains('group-emoji')) {
                panTimer = setTimeout(() => { isPanning = true; startPanX = touch.clientX - currentPanX; startPanY = touch.clientY - currentPanY; document.body.style.cursor = 'grabbing'; }, 500);
                return;
            }
            isDragging = false; isSpawning = false;
            activeElement = target; activeElement.classList.add('dragging'); 
            if (activeElement === menu) { elemStartX = activeElement.offsetLeft; elemStartY = activeElement.offsetTop; }
            else { 
                const r = activeElement.getBoundingClientRect(), cr = stickersLayer.getBoundingClientRect();
                elemStartX = ((r.left + r.width/2 - cr.left) / cr.width) * 100;
                elemStartY = ((r.top + r.height/2 - cr.top) / cr.height) * 100;
            }
        }

        function moveDragging(e) {
            const touch = e.type.startsWith("touch") ? e.touches[0] : e;
            const dx = touch.clientX - startX, dy = touch.clientY - startY;
            if (!isPanning && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) clearTimeout(panTimer);
            if (isPanning) { 
                currentPanX = touch.clientX - startPanX; currentPanY = touch.clientY - startPanY;
                document.documentElement.style.setProperty('--pan-x', currentPanX); document.documentElement.style.setProperty('--pan-y', currentPanY); return;
            }
            if (!activeElement) return;
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) isDragging = true;
            if (activeElement === menu) { menu.style.left = (elemStartX + dx) + "px"; menu.style.top = (elemStartY + dy) + "px"; updateMenuDynamics(); }
            else if (isSpawning) { activeElement.style.left = touch.clientX + "px"; activeElement.style.top = touch.clientY + "px"; }
            else { 
                const cr = stickersLayer.getBoundingClientRect();
                activeElement.style.left = (elemStartX + (dx / cr.width) * 100) + "%";
                activeElement.style.top = (elemStartY + (dy / cr.height) * 100) + "%"; updateIconBorder(activeElement);
            }
        }

        function handleEmojiRemove(emojiSpan, groupDiv) {
            emojiSpan.remove();
            const remaining = groupDiv.querySelectorAll('.group-emoji');
            if (remaining.length === 1) {
                const newIcon = createNormalSticker(remaining[0].innerText, groupDiv.style.left, groupDiv.style.top);
                stickersLayer.appendChild(newIcon); groupDiv.remove(); updateIconBorder(newIcon);
            } else if (remaining.length === 0) { groupDiv.remove(); } 
            else { updateIconBorder(groupDiv); }
            saveState();
        }

        function createNormalSticker(emoji, left, top) {
            const div = document.createElement('div');
            div.className = 'dropped-icon'; div.innerText = emoji; div.style.left = left; div.style.top = top;
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                if(!isDragging) { div.remove(); saveState(); }
            });
            return div;
        }

        function endDragging() { 
            clearTimeout(panTimer);
            if (isPanning) { isPanning = false; document.body.style.cursor = 'default'; saveState(); return; }
            if (activeElement && activeElement !== menu) {
                const others = document.querySelectorAll('.dropped-icon:not(.dragging)');
                let targetGroup = null;
                others.forEach(other => {
                    const isOtherGroup = other.classList.contains('sticker-group');
                    const currentCount = isOtherGroup ? other.querySelectorAll('.group-emoji').length : 1;
                    if (getOverlap(activeElement, other) > 0.6 && currentCount < 4) targetGroup = other;
                });

                if (targetGroup) {
                    if (!targetGroup.classList.contains('sticker-group')) {
                        const newGroup = document.createElement('div');
                        newGroup.className = 'dropped-icon sticker-group'; newGroup.style.left = targetGroup.style.left; newGroup.style.top = targetGroup.style.top;
                        const emoji1 = document.createElement('span'); emoji1.className = 'group-emoji'; emoji1.innerText = targetGroup.innerText;
                        emoji1.onclick = (e) => { e.stopPropagation(); handleEmojiRemove(emoji1, newGroup); };
                        newGroup.appendChild(emoji1); stickersLayer.appendChild(newGroup); targetGroup.remove(); targetGroup = newGroup;
                    }
                    const emoji2 = document.createElement('span');
                    emoji2.className = 'group-emoji'; emoji2.innerText = activeElement.innerText;
                    emoji2.onclick = (e) => { e.stopPropagation(); handleEmojiRemove(emoji2, targetGroup); };
                    targetGroup.appendChild(emoji2); activeElement.remove(); updateIconBorder(targetGroup);
                } else if (isSpawning) {
                    const cr = stickersLayer.getBoundingClientRect();
                    const rect = activeElement.getBoundingClientRect();
                    const finalX = ((rect.left + rect.width / 2 - cr.left) / cr.width) * 100;
                    const finalY = ((rect.top + rect.height / 2 - cr.top) / cr.height) * 100;
                    
                    const finalSticker = createNormalSticker(activeElement.innerText, finalX + "%", finalY + "%");
                    stickersLayer.appendChild(finalSticker);
                    activeElement.remove();
                    updateIconBorder(finalSticker);
                }
                if (activeElement && activeElement.parentNode) activeElement.classList.remove('dragging'); 
                saveState();
            } else if (activeElement === menu) { activeElement.classList.remove('dragging'); saveState(); }
            activeElement = null; isSpawning = false;
        }

        function initDragSpawn(e, emoji) {
            e.preventDefault(); e.stopPropagation();
            const touch = e.type.startsWith("touch") ? e.touches[0] : e, uniRect = universe.getBoundingClientRect();
            const div = document.createElement('div');
            div.className = 'dropped-icon dragging';
            div.innerText = emoji;
            div.style.width = (uniRect.width * 0.09) + "px";
            div.style.height = (uniRect.width * 0.09) + "px";
            div.style.left = touch.clientX + "px";
            div.style.top = touch.clientY + "px";
            div.style.position = 'fixed';
            document.body.appendChild(div);
            activeElement = div; isDragging = true; isSpawning = true; startX = touch.clientX; startY = touch.clientY;
        }

        document.addEventListener("mousedown", startDragging);
        document.addEventListener("touchstart", startDragging, { passive: false });
        document.addEventListener("mousemove", moveDragging);
        document.addEventListener("touchmove", moveDragging, { passive: false });
        document.addEventListener("mouseup", endDragging);
        document.addEventListener("touchend", endDragging);

        function getContrastYIQ(hexcolor){
            if (!hexcolor) return 'black';
            let r, g, b;
            if (hexcolor.startsWith('rgb')) { const colors = hexcolor.match(/\d+/g); r = parseInt(colors[0]); g = parseInt(colors[1]); b = parseInt(colors[2]); }
            else { hexcolor = hexcolor.replace("#", ""); r = parseInt(hexcolor.substr(0,2),16); g = parseInt(hexcolor.substr(2,2),16); b = parseInt(hexcolor.substr(4,2),16); }
            return (((r*299)+(g*587)+(b*114))/1000 >= 128) ? 'black' : 'white';
        }

        function updateIconBorder(icon) {
            const rect = icon.getBoundingClientRect(), cr = universe.getBoundingClientRect();
            const x = (rect.left + rect.width / 2) - (cr.left + cr.width / 2), y = (rect.top + rect.height / 2) - (cr.top + cr.height / 2);
            let angle = (Math.atan2(y, x) * (180 / Math.PI) + 360 + 90) % 360;
            const dayColor = getComputedStyle(document.documentElement).getPropertyValue('--day-color').trim();
            const nightColor = getComputedStyle(document.documentElement).getPropertyValue('--night-color').trim();
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim();
            if (Math.sqrt(x*x + y*y) < cr.width / 2) icon.style.borderColor = isAngleBetween(angle, currentSunriseAngle, currentSunsetAngle) ? getContrastYIQ(dayColor) : getContrastYIQ(nightColor);
            else icon.style.borderColor = getContrastYIQ(themeColor);
        }

        function isAngleBetween(t, s, e) { s = (s % 360 + 360) % 360; e = (e % 360 + 360) % 360; t = (t % 360 + 360) % 360; return s <= e ? (t >= s && t <= e) : (t >= s || t <= e); }

        function updateColors() {
            const root = document.documentElement;
            const bg = getComputedStyle(root).getPropertyValue('--theme-color').trim(), day = getComputedStyle(root).getPropertyValue('--day-color').trim(), night = getComputedStyle(root).getPropertyValue('--night-color').trim(), iconBg = getComputedStyle(root).getPropertyValue('--icon-bg').trim();
            const bgContrast = getContrastYIQ(bg);
            root.style.setProperty('--celestial-contrast', bgContrast);
            root.style.setProperty('--text-contrast', getContrastYIQ(iconBg));
            root.style.setProperty('--menu-bg', bgContrast === 'black' ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.2)');
            document.querySelectorAll('.hour-tick').forEach(tick => {
                const angle = parseFloat(tick.getAttribute('data-angle'));
                const color = isAngleBetween(angle, currentSunriseAngle, currentSunsetAngle) ? getContrastYIQ(day) : getContrastYIQ(night);
                tick.querySelector('.tick-mark').style.backgroundColor = color; if(tick.querySelector('.hour-number')) tick.querySelector('.hour-number').style.color = color;
            });
            document.querySelectorAll('.dropped-icon').forEach(updateIconBorder);
        }

        function drawClock(offset = 0) {
            const container = document.getElementById("ticks-container"); container.innerHTML = ''; 
            for (let i = 0; i < 24; i++) {
                const angle = ((i-12)*15)+offset, wrapper = document.createElement('div');
                wrapper.className = 'hour-tick'; wrapper.setAttribute('data-angle', angle);
                if (i % 6 === 0) { const num = document.createElement('div'); num.className = 'hour-number'; num.innerText = i === 0 ? "24" : (i < 10 ? "0"+i : i); num.style.transform = `translateX(-50%) rotate(${-angle}deg)`; wrapper.appendChild(num); }
                const mark = document.createElement('div'); mark.className = 'tick-mark'; wrapper.appendChild(mark); wrapper.style.transform = `translateX(-50%) rotate(${angle}deg)`; container.appendChild(wrapper);
            }
            updateColors();
        }

        function getSolarData() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetch(`https://api.sunrise-sunset.org/json?lat=${pos.coords.latitude}&lng=${pos.coords.longitude}&formatted=0`)
                    .then(r => r.json()).then(data => {
                        const noon = new Date(data.results.solar_noon); const offset = (12 - (noon.getHours() + noon.getMinutes() / 60)) * 15;
                        const sunRise = new Date(data.results.sunrise), sunSet = new Date(data.results.sunset);
                        currentSunriseAngle = (sunRise.getHours() + sunRise.getMinutes()/60 - 12) * 15 + offset;
                        currentSunsetAngle = (sunSet.getHours() + sunSet.getMinutes()/60 - 12) * 15 + offset;
                        drawClock(offset);
                        const polarToCartesian = (a) => ({ x: 50 + 50 * Math.cos((a - 90) * Math.PI / 180), y: 50 + 50 * Math.sin((a - 90) * Math.PI / 180) });
                        const start = polarToCartesian(currentSunriseAngle), end = polarToCartesian(currentSunsetAngle);
                        document.getElementById("day-path").setAttribute("d", `M 50 50 L ${start.x} ${start.y} A 50 50 0 ${((currentSunsetAngle - currentSunriseAngle + 360) % 360 <= 180 ? "0" : "1")} 1 ${end.x} ${end.y} Z`);
                        updateColors();
                    }).catch(() => { drawClock(0); hasLocationError = true; showLocationError(); });
                }, () => { drawClock(0); hasLocationError = true; showLocationError(); });
            } else { drawClock(0); hasLocationError = true; showLocationError(); }
        }

        function saveState() {
            const icons = [...document.querySelectorAll('#stickers-layer .dropped-icon')].map(i => ({
                text: i.classList.contains('sticker-group') ? [...i.querySelectorAll('.group-emoji')].map(s => s.innerText) : i.innerText,
                left: i.style.left, top: i.style.top, isGroup: i.classList.contains('sticker-group')
            }));
            localStorage.setItem('universeIcons', JSON.stringify(icons));
            localStorage.setItem('themeColor', getComputedStyle(document.documentElement).getPropertyValue('--theme-color'));
            localStorage.setItem('iconBg', getComputedStyle(document.documentElement).getPropertyValue('--icon-bg'));
            localStorage.setItem('dayColor', getComputedStyle(document.documentElement).getPropertyValue('--day-color'));
            localStorage.setItem('nightColor', getComputedStyle(document.documentElement).getPropertyValue('--night-color'));
            localStorage.setItem('zoomLevel', zoomSlider.value);
            localStorage.setItem('panPos', JSON.stringify({x: currentPanX, y: currentPanY}));
        }

        function loadState() {
            const zl = localStorage.getItem('zoomLevel'); if (zl) { zoomSlider.value = zl; document.documentElement.style.setProperty('--zoom-level', zl); }
            const pp = JSON.parse(localStorage.getItem('panPos')); if (pp) { currentPanX = pp.x; currentPanY = pp.y; document.documentElement.style.setProperty('--pan-x', currentPanX); document.documentElement.style.setProperty('--pan-y', currentPanY); }
            JSON.parse(localStorage.getItem('universeIcons') || "[]").forEach(d => {
                if (d.isGroup) {
                    const group = document.createElement('div'); group.className = 'dropped-icon sticker-group'; group.style.left = d.left; group.style.top = d.top;
                    d.text.forEach(txt => {
                        const span = document.createElement('span'); span.className = 'group-emoji'; span.innerText = txt;
                        span.onclick = (e) => { e.stopPropagation(); handleEmojiRemove(span, group); }; group.appendChild(span);
                    }); stickersLayer.appendChild(group);
                } else { const sticker = createNormalSticker(d.text, d.left, d.top); stickersLayer.appendChild(sticker); }
            });
            getSolarData(); updateMenuDynamics();
        }

        function setMoonPhase() {
            const moonEl = document.getElementById("moon-phase"), ageDays = (((new Date().getTime() - new Date('2000-01-06T18:14:00Z').getTime()) / 1000) % 2551443) / 86400;
            moonEl.classList.remove('moon-new', 'moon-first-quarter', 'moon-full', 'moon-last-quarter');
            if (ageDays < 1.845 || ageDays > 27.68) moonEl.classList.add('moon-new');
            else if (ageDays < 9.22) moonEl.classList.add('moon-first-quarter');
            else if (ageDays < 16.61) moonEl.classList.add('moon-full');
            else moonEl.classList.add('moon-last-quarter');
        }

        function exportPDF() { btns.forEach(b => document.getElementById(b).classList.remove('active')); window.print(); }
        
        function exportPNG() {
            btns.forEach(b => document.getElementById(b).classList.remove('active'));
            const menuEl = document.getElementById('draggable-menu');
            const originalMenuDisplay = menuEl.style.display;
            menuEl.style.display = 'none';
            html2canvas(document.body, { 
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim(), 
                scale: 2, useCORS: true, allowTaint: true, width: window.innerWidth, height: window.innerHeight 
            })
            .then(canvas => {
                menuEl.style.display = originalMenuDisplay;
                const link = document.createElement('a'); link.download = 'mijn-hemelplanner.png'; link.href = canvas.toDataURL("image/png"); link.click();
            });
        }
        
        loadState(); setMoonPhase(); setInterval(setMoonPhase, 3600000);
    </script>
</body>
</html>
